#jinja2: trim_blocks: False

{% set state = mlag.state|default(default_vlan_state) %}
{% set vlanid = mlag.local_if_vlan | regex_replace('\D+','') %}


{% if state == 'absent' %}

 {% set mlag_block = base_config | config_block('mlag configuration', indent=3) %}
  {% if mlag_block | join('\n') | re_search('^local-interface \S+') %}
no mlag configuration
  {% endif %}

{# Configure peering vlan #}
 {% set vlan_block = base_config | config_block('vlan ' ~ vlanid, indent=3) %}
 {% if vlan_block %}
no vlan {{ vlanid }}
 {% endif %}

{# Default Spanning Tree on Vlan #}
{% if base_config | re_search('^no spanning-tree vlan ' ~ vlanid) %}
spanning-tree vlan {{ vlanid }}
{% endif %}

{# Configure peering vlan interface #}
{% if base_config | config_block('interface ' ~ mlag.local_if_vlan, indent=3) %}
no interface {{ mlag.local_if_vlan }}
{% endif %}

{# Remove Port-Channel #}
{% if base_config | re_search('^interface ' ~ mlag.peer_link_if) %}
no interface {{ mlag.peer_link_if }}
{% endif %}

{% elif state == 'present' %}

{# Configure peering vlan #}
vlan {{ mlag.local_if_vlan | regex_replace('\D+','') }}
   name MLAG-PEERING
   trunk group {{ mlag.mlag_trunk_group }}
   state active

{# Disable Spanning Tree on Vlan #}
no spanning-tree vlan {{ vlanid }}

{# Configure peering vlan interface #}
interface {{ mlag.local_if_vlan }}
   description {{ mlag.local_if_vlan_description|default(mlag.mlag_domain_id) }}
   ip address {{ mlag.local_if_ip_address }}

{# Configure Port-Channel #}
interface {{ mlag.peer_link_if }}
   switchport mode {{ mlag.peer_link_mode }}
   switchport trunk group {{ mlag.mlag_trunk_group }}

{# Configure MLAG #}
mlag configuration
   local-interface {{ mlag.local_if_vlan }}
   peer-address {{ mlag.peer_address }}
   peer-link {{ mlag.peer_link_if }}

 {% if 'mlag_domain_id' in mlag %}
   domain-id {{ mlag.mlag_domain_id|default('mlagdomain') }}
 {% endif %}

 {% if mlag.mlag_shutdown %}
   shutdown
 {% else %}
   no shutdown
 {% endif %}

{% endif %}
